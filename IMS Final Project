#include <iostream>
#include <vector>
#include <memory>
#include <limits>
#include <fstream>
#include <sstream>

using namespace std;

/* ================= ITEM (BASE CLASS) ================= */
class Item {
protected:
    int id;
    string name;

public:
    Item(int i = 0, string n = "") : id(i), name(n) {}
    virtual ~Item() = default;

    int getId() const { return id; }
    string getName() const { return name; }

    virtual void display() const = 0;
};

/* ================= PRODUCT (DERIVED) ================= */
class Product : public Item {
    int quantity;
    double price;

public:
    Product(int i, string n, double p, int q)
        : Item(i, n), quantity(q), price(p) {}

    int getQuantity() const { return quantity; }
    double getPrice() const { return price; }

    double totalValue() const {
        return price * quantity;
    }

    void addStock(int amt) {
        if (amt > 0) quantity += amt;
    }

    bool removeStock(int amt) {
        if (amt > 0 && quantity >= amt) {
            quantity -= amt;
            return true;
        }
        return false;
    }

    bool isLowStock(int limit = 5) const {
        return quantity <= limit;
    }

    void display() const override {
        cout << "ID: " << id
             << " | Name: " << name
             << " | Price: $" << price
             << " | Qty: " << quantity
             << " | Value: $" << totalValue();
        if (isLowStock()) cout << " ⚠️ Low stock!";
        cout << '\n';
    }

    /* Save format */
    string toFile() const {
        return to_string(id) + "|" + name + "|" +
               to_string(price) + "|" + to_string(quantity);
    }
};

/* ================= INVENTORY ================= */
class Inventory {
    vector<unique_ptr<Product>> products;
    const string filename = "inventory.txt";

    int findIndex(int id) const {
        for (int i = 0; i < products.size(); i++)
            if (products[i]->getId() == id)
                return i;
        return -1;
    }

    int getInt(const string& msg) {
        int v;
        cout << msg;
        while (!(cin >> v)) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Invalid. Try again: ";
        }
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        return v;
    }

    double getDouble(const string& msg) {
        double v;
        cout << msg;
        while (!(cin >> v)) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Invalid. Try again: ";
        }
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        return v;
    }

    string getString(const string& msg) {
        string s;
        cout << msg;
        getline(cin, s);
        return s;
    }

public:
    Inventory() {
        loadFromFile();
    }

    ~Inventory() {
        saveToFile();
    }

    /* ADD PRODUCT */
    void addProduct() {
        int id = getInt("Enter ID: ");
        if (findIndex(id) != -1) {
            cout << "❌ Duplicate ID\n";
            return;
        }

        string name = getString("Enter name: ");
        double price = getDouble("Enter price: ");
        int qty = getInt("Enter quantity: ");

        products.push_back(make_unique<Product>(id, name, price, qty));
        cout << "✅ Product added\n";
    }

    /* DELETE PRODUCT */
    void deleteProduct() {
        int id = getInt("Enter ID to delete: ");
        int i = findIndex(id);
        if (i == -1) {
            cout << "❌ Product not found!\n";
            return;
        }
        products.erase(products.begin() + i);
        cout << "✅ Product deleted\n";
    }

    /* ADD STOCK */
    void addStock() {
        int id = getInt("Enter product ID: ");
        int i = findIndex(id);
        if (i == -1) {
            cout << "❌ Product not found!\n";
            return;
        }
        int amt = getInt("Enter amount: ");
        products[i]->addStock(amt);
        cout << "✅ Stock added\n";
    }

    /* REMOVE STOCK */
    void removeStock() {
        int id = getInt("Enter product ID: ");
        int i = findIndex(id);
        if (i == -1) {
            cout << "❌ Product not found!\n";
            return;
        }
        int amt = getInt("Enter amount: ");
        if (!products[i]->removeStock(amt))
            cout << "❌ Not enough stock\n";
        else
            cout << "✅ Stock removed\n";
    }

    /* SEARCH PRODUCT */
    void searchProduct() const {
        int id;
        cout << "Enter product ID: ";
        cin >> id;
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        int i = findIndex(id);
        if (i == -1) {
            cout << "❌ Product not found!\n";
            return;
        }
        products[i]->display();
    }

    /* VIEW ALL */
    void viewAll() const {
        if (products.empty()) {
            cout << "\n--- Nothing found. Please add your product! ---\n";
            return;
        }

        double totalInventoryValue = 0;
        for (const auto& p : products) {
            p->display();
            totalInventoryValue += p->totalValue();
        }

        cout << "---------------------------------\n";
        cout << "Total Inventory Value: $" 
             << totalInventoryValue << '\n';
    }

    /* SAVE */
    void saveToFile() const {
        ofstream file(filename);
        for (const auto& p : products)
            file << p->toFile() << '\n';
    }

    /* LOAD */
    void loadFromFile() {
        ifstream file(filename);
        if (!file) return;

        string line;
        while (getline(file, line)) {
            stringstream ss(line);
            string id, name, price, qty;

            getline(ss, id, '|');
            getline(ss, name, '|');
            getline(ss, price, '|');
            getline(ss, qty, '|');

            products.push_back(
                make_unique<Product>(
                    stoi(id), name, stod(price), stoi(qty)
                )
            );
        }
    }
};

/* ================= MAIN ================= */
int main() {
    Inventory inv;
    int choice;

    do {
        cout << "==================================\n";
        cout << "       INVENTORY SYSTEM\n";
        cout << "==================================\n"
             << "1. View all products\n"
             << "2. Add product\n"
             << "3. Delete product\n"
             << "4. Add stock\n"
             << "5. Remove stock\n"
             << "6. Search product\n"
             << "0. Exit\n"
             << "Choose one option above: ";

        cin >> choice;
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        switch (choice) {
            case 1: inv.viewAll(); break;
            case 2: inv.addProduct(); break;
            case 3: inv.deleteProduct(); break;
            case 4: inv.addStock(); break;
            case 5: inv.removeStock(); break;
            case 6: inv.searchProduct(); break;
        }
    } while (choice != 0);

    cout << "Inventory saved. Goodbye!\n";
    return 0;
}

